name: Deploy Fusion to Staging / Production
on:
  push:
    branches:
      - UX-1020-update-firebase-deployment-to-support-fusion-cdf-both

env:
  NODE_OPTIONS: '--max_old_space_size=4096'

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - name: Install & build ðŸ”§
        run: yarn --network-timeout 1000000 --frozen-lockfile && npx nx build fusion-shell --configuration=staging
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_READONLY_TOKEN }}

      # Deploying to staging and prod on master by default for now
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_HOSTING_DEPLOY_SA }}'
          channelId: live
          projectId: fbhosting-217032465111-preview
          target: cognite-fusion-preview
          entryPoint: './dist/apps/fusion-shell/cdf'

      - name: Deploy to Firebase Functions
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only functions
        env:
          FIREBASE_TOKEN: '${{ secrets.FIREBASE_HOSTING_DEPLOY_SA }}'
          PROJECT_ID: fbhosting-217032465111-preview

      # - uses: FirebaseExtended/action-hosting-deploy@v0
      #   with:
      #     repoToken: '${{ secrets.GITHUB_TOKEN }}'
      #     firebaseServiceAccount: '${{ secrets.FIREBASE_HOSTING_DEPLOY_SA }}'
      #     channelId: live
      #     projectId: fbhosting-217032465111
      #     target: cognite-fusion-production

      # Bring this back when the release strategy is in place for fdx
      # - uses: FirebaseExtended/action-hosting-deploy@v0
      #   with:
      #     repoToken: '${{ secrets.GITHUB_TOKEN }}'
      #     firebaseServiceAccount: '${{ secrets.FIREBASE_HOSTING_DEPLOY_SA }}'
      #     channelId: live
      #     projectId: ${{ github.ref_name != 'master' && 'fbhosting-217032465111' || 'fbhosting-217032465111-staging' }}
      #     target: cognite-flexible-data-explorer-${{ github.ref_name != 'master' && 'production' || 'staging' }}
