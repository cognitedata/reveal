{"ast":null,"code":"var _s = $RefreshSig$();\nimport { useContext } from 'react';\nimport { useMutation } from '@tanstack/react-query';\nimport uniq from 'lodash/uniq';\nimport { useSDK } from '@cognite/sdk-provider';\nimport { AppContext, isNotUndefined } from '@data-exploration-lib/core';\nimport { getFileExternalIdFromExtendedAnnotation, getFileIdFromExtendedAnnotation, getResourceIdFromExtendedAnnotation, isApprovedAnnotation, isAssetAnnotation, isExtendedLocalAnnotation } from '../../utils';\nconst CREATING_APP = 'data-exploration-components';\nconst CREATING_VERSION_SEM_VER = '1.0.0';\nexport const persistAssetIds = async (sdk, annotations) => {\n  const approvedAnnotations = annotations.filter(annotation => isApprovedAnnotation(annotation));\n  const fileIds = uniq(approvedAnnotations.map(getFileIdFromExtendedAnnotation).filter(isNotUndefined)).map(id => ({\n    id\n  }));\n  const fileExternalIds = uniq(approvedAnnotations.map(getFileExternalIdFromExtendedAnnotation).filter(isNotUndefined)).map(externalId => ({\n    externalId\n  }));\n  const fileIdsEither = [...fileIds, ...fileExternalIds];\n  if (fileIdsEither.length === 0) {\n    return;\n  }\n\n  // Old code here\n  // https://github.com/cognitedata/cognite-annotations/blob/0d22f229a3e5caac92916abc6f0450135e00de43/typescript/src/ContextAnnotationUtils.ts#L28-L87\n\n  const assetIds = uniq(approvedAnnotations.filter(isAssetAnnotation).map(getResourceIdFromExtendedAnnotation)).filter(isNotUndefined);\n  if (assetIds.length === 0) {\n    return;\n  }\n  return sdk.files.update(fileIdsEither.map(fileIdEither => ({\n    ...fileIdEither,\n    update: {\n      assetIds: {\n        add: assetIds\n      }\n    }\n  })));\n};\nexport const useCreateAnnotation = options => {\n  _s();\n  const context = useContext(AppContext);\n  const email = context?.userInfo?.email || 'UNKNOWN';\n  const sdk = useSDK();\n  const {\n    mutate\n  } = useMutation(async annotation => {\n    if (!isExtendedLocalAnnotation(annotation)) {\n      throw new Error('Attempted to create annotation that is not local');\n    }\n    const annotationCreationPromise = sdk.annotations.create([{\n      status: 'approved',\n      creatingApp: CREATING_APP,\n      creatingAppVersion: CREATING_VERSION_SEM_VER,\n      creatingUser: email,\n      // TOOD: Confirm\n      annotatedResourceType: annotation.metadata.annotatedResourceType,\n      annotationType: annotation.metadata.annotationType,\n      annotatedResourceId: annotation.metadata.annotatedResourceId,\n      data: annotation.metadata.data\n    }]);\n    const fileAssetUpdatePromise = persistAssetIds(sdk, [annotation]);\n    return Promise.all([annotationCreationPromise, fileAssetUpdatePromise]);\n  }, options);\n  return mutate;\n};\n_s(useCreateAnnotation, \"qsBsn+cxyPsKUKOa44hbaQlyBE8=\", false, function () {\n  return [useSDK, useMutation];\n});","map":{"version":3,"names":["useContext","useMutation","uniq","useSDK","AppContext","isNotUndefined","getFileExternalIdFromExtendedAnnotation","getFileIdFromExtendedAnnotation","getResourceIdFromExtendedAnnotation","isApprovedAnnotation","isAssetAnnotation","isExtendedLocalAnnotation","CREATING_APP","CREATING_VERSION_SEM_VER","persistAssetIds","sdk","annotations","approvedAnnotations","filter","annotation","fileIds","map","id","fileExternalIds","externalId","fileIdsEither","length","assetIds","files","update","fileIdEither","add","useCreateAnnotation","options","context","email","userInfo","mutate","Error","annotationCreationPromise","create","status","creatingApp","creatingAppVersion","creatingUser","annotatedResourceType","metadata","annotationType","annotatedResourceId","data","fileAssetUpdatePromise","Promise","all"],"sources":["/Volumes/csvol/fusion/libs/data-exploration/domain-layer/src/annotations/service/actions/useCreateAnnotation.ts"],"sourcesContent":["import { useContext } from 'react';\n\nimport { useMutation } from '@tanstack/react-query';\nimport uniq from 'lodash/uniq';\n\nimport { CogniteClient } from '@cognite/sdk';\nimport { useSDK } from '@cognite/sdk-provider';\n\nimport {\n  AppContext,\n  ExtendedAnnotation,\n  isNotUndefined,\n} from '@data-exploration-lib/core';\n\nimport {\n  getFileExternalIdFromExtendedAnnotation,\n  getFileIdFromExtendedAnnotation,\n  getResourceIdFromExtendedAnnotation,\n  isApprovedAnnotation,\n  isAssetAnnotation,\n  isExtendedLocalAnnotation,\n} from '../../utils';\n\nconst CREATING_APP = 'data-exploration-components';\nconst CREATING_VERSION_SEM_VER = '1.0.0';\n\nexport const persistAssetIds = async (\n  sdk: CogniteClient,\n  annotations: ExtendedAnnotation[]\n) => {\n  const approvedAnnotations = annotations.filter((annotation) =>\n    isApprovedAnnotation(annotation)\n  );\n  const fileIds = uniq(\n    approvedAnnotations\n      .map(getFileIdFromExtendedAnnotation)\n      .filter(isNotUndefined)\n  ).map((id) => ({ id }));\n  const fileExternalIds = uniq(\n    approvedAnnotations\n      .map(getFileExternalIdFromExtendedAnnotation)\n      .filter(isNotUndefined)\n  ).map((externalId) => ({ externalId }));\n\n  const fileIdsEither = [...fileIds, ...fileExternalIds];\n\n  if (fileIdsEither.length === 0) {\n    return;\n  }\n\n  // Old code here\n  // https://github.com/cognitedata/cognite-annotations/blob/0d22f229a3e5caac92916abc6f0450135e00de43/typescript/src/ContextAnnotationUtils.ts#L28-L87\n\n  const assetIds = uniq(\n    approvedAnnotations\n      .filter(isAssetAnnotation)\n      .map(getResourceIdFromExtendedAnnotation)\n  ).filter(isNotUndefined);\n\n  if (assetIds.length === 0) {\n    return;\n  }\n\n  return sdk.files.update(\n    fileIdsEither.map((fileIdEither) => ({\n      ...fileIdEither,\n      update: {\n        assetIds: {\n          add: assetIds,\n        },\n      },\n    }))\n  );\n};\n\nexport const useCreateAnnotation = (options: any) => {\n  const context = useContext(AppContext);\n  const email = context?.userInfo?.email || 'UNKNOWN';\n  const sdk = useSDK();\n  const { mutate } = useMutation(async (annotation: ExtendedAnnotation) => {\n    if (!isExtendedLocalAnnotation(annotation)) {\n      throw new Error('Attempted to create annotation that is not local');\n    }\n\n    const annotationCreationPromise = sdk.annotations.create([\n      {\n        status: 'approved',\n        creatingApp: CREATING_APP,\n        creatingAppVersion: CREATING_VERSION_SEM_VER,\n        creatingUser: email, // TOOD: Confirm\n        annotatedResourceType: annotation.metadata.annotatedResourceType,\n        annotationType: annotation.metadata.annotationType,\n        annotatedResourceId: annotation.metadata.annotatedResourceId,\n        data: annotation.metadata.data,\n      },\n    ]);\n\n    const fileAssetUpdatePromise = persistAssetIds(sdk, [annotation]);\n\n    return Promise.all([annotationCreationPromise, fileAssetUpdatePromise]);\n  }, options);\n  return mutate;\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}