/*!
 * Copyright 2023 Cognite AS
 */
import type { Meta, StoryObj } from '@storybook/react';
import { CadModelContainer, CadModelStyling, CogniteCadModelProps, NodeStylingGroup, RevealContainer, useReveal } from '../src';
import { Color, Matrix4 } from 'three';
import { createSdkByUrlToken } from './utilities/createSdkByUrlToken';
import { CogniteCadModel, DefaultNodeAppearance, NumericRange } from '@cognite/reveal';
import { useSDK } from '../src/components/RevealContainer/SDKProvider';
import { useEffect, useMemo, useState } from 'react';

const meta = {
  title: 'Example/PrimitiveWrappers/CadModelContainer',
  component: CadModelContainer,
  argTypes: {
    styling: {
      description: 'Styling of the first model',
      options: ['FullRed', 'HalfGreen', 'SomeBlue', 'Colorful', 'None'],
      control: {
        type: 'radio'
      },
      label: 'Styling of the first model',
      mapping: {
        FullRed: {
          defaultStyle: { color: new Color('red') }
        },
        HalfGreen: {
          groups: [
            {
              treeIndices: new NumericRange(0, 40),
              style: { color: new Color('green') }
            }
          ]
        },
        SomeBlue: {
          groups: [
            {
              nodeIds: [
                8757509474262596, 2712303310330098, 1903632131225149, 8923105504012177,
                3709428615074138
              ],
              style: { color: new Color('blue') }
            }
          ]
        },
        Colorful: {
          groups: [
            {
              treeIndices: new NumericRange(0, 40),
              style: { color: new Color('red') }
            },
            {
              nodeIds: [1903632131225149, 8923105504012177],
              style: { color: new Color('green') }
            },
            {
              nodeIds: [8757509474262596, 2712303310330098, 3709428615074138],
              style: { color: new Color('blue') }
            }
          ]
        },
        None: {}
      }
    },
    addModelOptions: {
      description: 'Options for loading the model',
      options: ['Platform', 'primitives'],
      control: {
        type: 'radio'
      },
      label: 'Options for loading the model',
      mapping: {
        Platform: {
          modelId: 2231774635735416,
          revisionId: 912809199849811,
        },
        primitives: {
          modelId: 1791160622840317,
          revisionId: 498427137020189
        }
      }
    },
  },
  tags: ['autodocs']
} satisfies Meta<typeof CadModelContainer>;

export default meta;
type Story = StoryObj<typeof meta>;

const sdk = createSdkByUrlToken();

export const Main: Story = {
  args: {
    addModelOptions: {
      modelId: 1791160622840317,
      revisionId: 498427137020189
    },
    styling: {
      defaultStyle: { color: new Color('red') }
    },
    transform: new Matrix4().makeTranslation(0, 10, 0)
  },
  render: ({ addModelOptions, transform, styling }) => (
    <RevealContainer sdk={sdk} color={new Color(0x4a4a4a)}>
      <Models addModelOptions={addModelOptions} styling={styling} transform={transform} />
    </RevealContainer>
  )
};

const Models = ({ addModelOptions, styling, transform }: CogniteCadModelProps) => {
  const platformModelOptions = {
    modelId: 2231774635735416,
    revisionId: 912809199849811,
  };

  const viewer = useReveal();
  const sdk = useSDK();

  const [platformStyling, setPlatformStyling] = useState<CadModelStyling>();

  useEffect(() => {
   const callback = () => {
      console.log('Clicked', platformStyling);
      if (!platformStyling) return;

      setPlatformStyling((prev) => {
        if (!prev?.groups) return prev;
        console.log('Switched groups', prev);
        const nodeIds1 = (prev.groups[0] as NodeStylingGroup).nodeIds;
        const nodeIds2 = (prev.groups[1] as NodeStylingGroup).nodeIds;

        return {
          groups: [
            { nodeIds: nodeIds1, style: prev.groups[1].style },
            { nodeIds: nodeIds2, style: prev.groups[0].style }],
          defaultStyle: prev.defaultStyle
        }
      });
    };

    viewer.on('click', callback);
    return () => {
      viewer.off('click', callback);
    }
  }, [viewer, platformStyling, setPlatformStyling])

  useEffect(() => {
      const stylingGroupRed: NodeStylingGroup = {
        nodeIds: nodeIds.slice(0, nodeIds.length / 2),
        style: {
          color: new Color('red'),
          renderInFront: true
        }
      };

      const stylingGroupGreen: NodeStylingGroup = {
        nodeIds: nodeIds.slice(nodeIds.length / 2),
        style: {
          color: new Color('green'),
          renderInFront: true
        }
      };
  
      setPlatformStyling({
        defaultStyle: DefaultNodeAppearance.Ghosted,
        groups: [
          stylingGroupRed, stylingGroupGreen
        ]
      });
    console.log('set')
  }, [viewer])

  const onModelLoaded = (model: CogniteCadModel) => {
    viewer.fitCameraToModel(model);

  };

  return (<>
    <CadModelContainer addModelOptions={addModelOptions} styling={styling} />
    <CadModelContainer addModelOptions={addModelOptions} transform={transform} />
    <CadModelContainer addModelOptions={platformModelOptions} styling={platformStyling} onLoad={onModelLoaded}/>
    </>
  )

}

const nodeIds = [
  2232218418169407,
  5658577936769408,
  850382017588429,
  3070761313703702,
  3951638513367021,
  7062796113231733,
  2890847372912846,
  329414570333157,
  3629108135100276,
  6317623811412748,
  3132072649556228,
  2726225038443969,
  2932725123656106,
  3226066987026890,
  4225780917622524,
  6134425481105724,
  2285108134118877,
  4895188366493601,
  7536239725308596,
  7270047026645699,
  2626204883430557,
  7110745942138479,
  1320701435836329,
  4932154987670732,
  5561976338058552,
  8585314482358661,
  3822385615581213,
  154183744718998,
  5407312049549142,
  5207624370422737,
  7499557176975927,
  7252351865157651,
  6933485139703381,
  8754451026445878,
  1232806473391717,
  5917653538136582,
  1755567204822641,
  1351385828846457,
  2128934868419473,
  2503220405110192,
  4634526971646329,
  4158483921244371,
  7961885375856537,
  4104801088011248,
  3750796776631479,
  2584731810316337,
  498137311746221,
  4791360702859696,
  6500600617032668,
  728514796395105,
  7039613828720414,
  3579588444809187,
  3620270090035158,
  4367529035537091,
  271957669939998,
  7242926318151085,
  7286286292640949,
  8216566542073808,
  4616282668591069,
  5892237431475311,
  8220317969061225,
  3555315714461463,
  2975488196427597,
  7665362970012559,
  4256981829504730,
  3060038785936745,
  997663930455642,
  2930986363868254,
  2364570495837666,
  2832659029323511,
  2880215631848216,
  2669883667650235,
  4610475560463037,
  7492661107659212,
  6621395489584442,
  4902705304409561,
  8800326492810657,
  6621637609040873,
  2102448405642500,
  5530717018384096,
  6888865510554339,
  4907195933528348,
  4743344537729957,
  25455121853364,
  2034143278491262,
  2201307064206191,
  6065734666173407,
  4592291020511820,
  8137992243796259,
  692379851314927,
  8324892155591347,
  3446238074833631,
  7527648338366047,
  3885996703084904,
  2975775721883436,
  5263246819344133,
  3583494377769207,
  555992206417760,
  7294462433542425,
  5682522206626027,
  8676265746969580,
  198999418881583,
  8711854362484470,
  4875158983286720,
  7219620183216414,
  34571823193079,
  6828092090274380,
  7414384386861196,
  8602505850105083,
  6997175233352076,
  7759728187277342,
  2553265838913607,
  5102816378849512,
  8766717328382417,
  2006146417150347,
  3006740898572877,
  5905375144781770,
  925063770515514,
  5284539199651983,
  279148037720718,
  5787135245039006,
  7932323292205943,
  7402725145786427,
  118964789943956,
  711861941495839,
  3070102389407417,
  7364526231720377,
  6070513108330635,
  727607099853490,
  141540774370654,
  7817885637363781,
  3990782304578802,
  4668065098130519,
  4933736309362616,
  849857786108827,
  3505867206381840,
  1209557143492295,
  8661432136821202,
  1826530052943424,
  3121021695023927,
  7192754198768519,
  5002167070752284,
  662629953719312,
  1935366604572895,
  4780267596829279,
  3093026845213921,
  5444954582905103,
  4028374640488654,
  4732769354874992,
  1475700456483115,
  299806778805925,
  3423060508591004,
  4334633010473043,
  4324937880436485,
  2344351581447862,
  8330072591082327,
  2826383665722867,
  2720746992919770,
  2011741768060376,
  4093520643752450,
  3499433624636420,
  950797107712717,
  6851815362465799,
  1892729536775625,
  8246262669005608,
  8098520481776797,
  680329373524409,
  2762751334287092,
  8762116741352180,
  2889870642924348,
  6019707882510524,
  6577512323394445,
  1945308381712604,
  7208982699069664,
  1241480647679389,
  3903148523697536,
  4149644145717807,
  3139447669547605,
  4262185776728912,
  1371021150151527,
  7189806409997970,
  4432552089664097,
  980796118601058,
  8743351064478646,
  7348305605447562,
  8234993115905325,
  7182835890094527,
  8644405019668254,
  8502996988396104,
  831119596986887,
  2071417315098657,
  8629041551050020,
  4515281288140608,
  5457269724262971,
  144722803619683,
  6101995079314884,
  3067586355614872,
  5252678132083595,
  2508615019154949,
  6607999164226217,
  3929709092168848,
  2775671243522419,
  7453734678900593,
  4811785647842680,
  7552973057601565,
  443842137093468,
  3049479175999101,
  6435726933948316,
  5739669201289118,
  3091874138517747,
  1251211492280707,
  3098556580855864,
  3570386273694830,
  5501641707257004,
  2155482985423291,
  2213312333978842,
  1013085342558723,
  5911850450598476,
  1892075289642097,
  8135290362063404,
  4390016990178663,
  5836459086931465,
  3314992517592667,
  6689618086395229,
  5597563395630900,
  7288316612454885,
  5899768741316600,
  7681953285429760,
  2661260038354254,
  4298086267539542,
  7007327501314101,
  2946221559543784,
  6138402523926122,
  514593019224716,
  7970581484536327,
  5514728598651546,
  4104901431829357,
  2430484273251454,
  3867634560819753,
  8320664783887670,
  967982137658398,
  5353219227511554,
  7344700329782454,
  6324669711027317,
  5356820835735662,
  7077830013037871,
  5591439437921687,
  1253958278469631,
  931058564416313,
  5774856351838285,
  8946064043939524,
  1128008780843832,
  8752433910049575,
  6417500990690933,
  6778735373554881,
  2149481470857409,
  924341938637206,
  4016423801827289,
  4555177511438054,
  7440487664251590,
  8985366314487520,
  6560732714687335,
  3994269814460074,
  2566424251668553,
  7315752334925668,
  4318806242657566,
  346609986436190,
  532831593598231,
  1869464011666570,
  3883093941161078,
  4649974326121018,
  144668328922074,
  6853481256895614,
  1492025074488190,
  8552891585063693,
  416292938404570,
  2006710716496568,
  5571956625471292,
  2650260148207043,
  2448498473916829,
  6102214296714891,
  1937484563898861,
  3174080691629571,
  4392523789706723,
  855322859641160,
  1449744906430713,
  4256454126500662,
  4616170357917745,
  4640032410185112,
  5672777298342496,
  832831909115147,
  4520698683246954,
  6231212485562846,
  4633495469221781,
  1385683465524289,
  8821381123414857,
  2422729069143840,
  7946338012355955,
  3743601993253562,
  5168374665948426,
  4953884229868239,
  343155787498534,
  1676807490178869,
  8036661664236580,
  4060199792604651,
  5634419412422297,
  5037831569269536,
  195115417187320,
  3271667814488349,
  5458055067420832,
  7733933640544041,
  7269744132063180,
  3468238381943959,
  1166251006793291,
  507958499674850,
  5683738934825806,
  1635882865438970,
  494380298227407,
  7601845427024246,
  5769690128778524,
  3047663533848000,
  3128288852180892,
  7842108628292445,
  6275319047773237,
  3431439712084513,
  5177933888503763,
  2314316497929097,
  4397415069638850,
  5435344339219256,
  4409715838126721,
  4831871719462694,
  3051164025413885,
  3973653593670201,
  126761174540900,
  7478369195468693,
  682866599534966,
  868601466066303,
  2258592553531770,
  7035223967096518,
  8754764702094268,
  5838856148555569,
  647355000773438,
  8765572596501757,
  3196644868095143,
  2763573009388555,
  1733159130649181,
  3805039564129517,
  3304254590054989,
  8108648871063725,
  3243634535637777,
  6440211192675099,
  7217106319781808,
  8603437315005695,
  1658428418567455,
  6907719244848960,
  8806931620775337,
  3408585091392211,
  7847406107266115,
  4331895197503672,
  5467945087916280,
  6502466696159568,
  1994809631622449,
  1442360844256170,
  4334915638863818,
  3226223550423755,
  5101956551409906,
  2597451321366801,
  2806478779618144
]